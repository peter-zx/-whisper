<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Whisper å­—å¹•ç”Ÿæˆå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .upload-drag {
      border: 2px dashed #cbd5e1;
      transition: all 0.3s;
    }
    .upload-drag.drag-over {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    .subtitle-line:hover { @apply bg-blue-50 cursor-pointer; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- å¼¹çª—å¹¿å‘Š -->
  <div id="adPopup" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-xs hidden">
    <div class="flex justify-between items-start">
      <p class="text-sm">âœ¨ æ–°åŠŸèƒ½é¢„å‘Šï¼šæ”¯æŒæ‰¹é‡å¤„ç†ä¸AIæ¶¦è‰²ï¼</p>
      <button onclick="document.getElementById('adPopup').classList.add('hidden')" class="text-gray-500">&times;</button>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow-sm py-3 px-6 flex justify-between items-center">
    <h1 class="text-xl font-bold text-primary">Whisper å­—å¹•ç”Ÿæˆå™¨</h1>
    <div class="flex items-center space-x-4">
      <select id="languageSelect" class="text-sm border rounded px-2 py-1">
        <option value="zh">ç®€ä½“ä¸­æ–‡</option>
      </select>
      <a href="https://github.com/peter-zx/-whisper" target="_blank" class="text-sm text-gray-600 hover:text-primary">GitHub</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-6 space-y-8">

    <!-- ä¸Šä¼ é…ç½®åŒº -->
    <section class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-lg font-semibold mb-4">ğŸ“ ä¸Šä¼ ä¸é…ç½®</h2>
      <div id="dropZone" class="upload-drag rounded-lg p-8 text-center mb-4">
        <p class="mb-2">æ‹–æ‹½éŸ³è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–</p>
        <input type="file" id="fileInput" accept="audio/*,video/*" class="hidden" />
        <button id="browseBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-blue-600">é€‰æ‹©æ–‡ä»¶</button>
        <p id="fileName" class="mt-2 text-sm text-gray-500"></p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">æ¨¡å‹é€‰æ‹©</label>
          <select id="modelSelect" class="w-full border rounded px-3 py-2">
            <option value="base">Baseï¼ˆå¿«é€Ÿï¼‰</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large-v3" selected>Large-v3ï¼ˆé«˜ç²¾åº¦ï¼‰</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">è¾“å‡ºè¯­è¨€</label>
          <select id="outputLang" class="w-full border rounded px-3 py-2">
            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
            <option value="zh" selected>å¼ºåˆ¶ç®€ä½“ä¸­æ–‡</option>
          </select>
        </div>
      </div>

      <button id="transcribeBtn" class="w-full bg-primary text-white py-2 rounded hover:bg-blue-600 disabled:opacity-50">
        â–¶ï¸ å¼€å§‹è½¬å½•
      </button>
    </section>

    <!-- æˆæœå±•ç¤ºåŒº -->
    <section class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-lg font-semibold mb-4">ğŸ“º æˆæœå±•ç¤º</h2>
      <div id="progressContainer" class="mb-4 hidden">
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="progressBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-600 mt-1">æ­£åœ¨å¤„ç†...</p>
      </div>

      <div id="resultContainer" class="hidden">
        <div class="mb-3 flex justify-between">
          <span class="text-sm text-gray-500">ç‚¹å‡»å­—å¹•å¯è·³è½¬æ’­æ”¾</span>
          <button id="copyAllBtn" class="text-sm text-primary hover:underline">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
        </div>
        <div id="subtitlesDisplay" class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto font-mono text-sm">
          <!-- åŠ¨æ€æ’å…¥å­—å¹• -->
        </div>
      </div>

      <div id="placeholderMessage" class="text-center text-gray-500 py-8">
        è½¬å½•ç»“æœå°†åœ¨æ­¤å¤„æ˜¾ç¤º...
      </div>
    </section>

    <!-- å­—å¹•ä¸‹è½½åŒº -->
    <section class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-lg font-semibold mb-4">ğŸ“¥ å­—å¹•ä¸‹è½½</h2>
      <div class="flex flex-wrap gap-3">
        <button class="download-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm">SRT æ ¼å¼</button>
        <button class="download-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm">TXT æ–‡æœ¬</button>
        <button class="download-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm">VTT å­—å¹•</button>
        <button class="download-btn bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm">JSON æ•°æ®</button>
      </div>
    </section>

    <!-- æœªæ¥åŠŸèƒ½åŒº -->
    <details class="bg-white p-6 rounded-xl shadow">
      <summary class="cursor-pointer list-none font-semibold">â• æœªæ¥æ–°å¢åŠŸèƒ½ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
      <ul class="mt-3 space-y-2 text-sm text-gray-600">
        <li>â€¢ æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡ä»¶</li>
        <li>â€¢ AI è‡ªåŠ¨æ¶¦è‰²å­—å¹•</li>
        <li>â€¢ å¯¼å‡ºå¸¦ç¡¬å­—å¹•çš„è§†é¢‘</li>
        <li>â€¢ å¤šè¯­ç§å®æ—¶ç¿»è¯‘</li>
      </ul>
    </details>

  </main>

  <footer class="text-center py-6 text-gray-500 text-sm">
    Â© 2025 peter-zx | 
    <a href="https://github.com/peter-zx/-whisper" target="_blank" class="text-primary hover:underline">å¼€æºé¡¹ç›®</a> | 
    ä»…ç”¨äºå­¦ä¹ ä¸éå•†ä¸šç”¨é€”
  </footer>

  <script>
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const dropZone = document.getElementById('dropZone');
    const fileName = document.getElementById('fileName');
    const transcribeBtn = document.getElementById('transcribeBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultContainer = document.getElementById('resultContainer');
    const subtitlesDisplay = document.getElementById('subtitlesDisplay');
    const placeholderMessage = document.getElementById('placeholderMessage');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const adPopup = document.getElementById('adPopup');

    // æ–‡ä»¶é€‰æ‹©
    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => updateFileName());

    function updateFileName() {
      if (fileInput.files.length > 0) {
        fileName.textContent = `å·²é€‰æ‹©ï¼š${fileInput.files[0].name}`;
        transcribeBtn.disabled = false;
      } else {
        fileName.textContent = '';
        transcribeBtn.disabled = true;
      }
    }

    // æ‹–æ‹½
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        updateFileName();
      }
    });

    // å¼€å§‹è½¬å½•
    transcribeBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
      
      progressContainer.classList.remove('hidden');
      resultContainer.classList.add('hidden');
      placeholderMessage.classList.add('hidden');

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('model', document.getElementById('modelSelect').value);
      formData.append('language', document.getElementById('outputLang').value);

      try {
        let progress = 0;
        const interval = setInterval(() => {
          progress += 5;
          progressBar.style.width = progress + '%';
          progressText.textContent = `å¤„ç†ä¸­... ${progress}%`;
          if (progress >= 100) clearInterval(interval);
        }, 150);

        const res = await fetch('/transcribe', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        showResult(data.segments, data.download_base, data.temp_dir);
      } catch (err) {
        alert('âŒ é”™è¯¯ï¼š' + err.message);
        progressContainer.classList.add('hidden');
        placeholderMessage.classList.remove('hidden');
      }
    });

    function showResult(segments, baseName, tempDir) {
      progressContainer.classList.add('hidden');
      resultContainer.classList.remove('hidden');

      subtitlesDisplay.innerHTML = segments.map(seg => `
        <div class="subtitle-line p-2 border-b border-gray-100" data-start="${seg.start}">
          <span class="text-blue-600">[${seg.start.toFixed(2)} â†’ ${seg.end.toFixed(2)}]</span><br>
          <span>${seg.text}</span>
        </div>
      `).join('');

      // æ˜¾ç¤ºå¹¿å‘Š
      setTimeout(() => adPopup.classList.remove('hidden'), 2000);

      // ä¸‹è½½æŒ‰é’®ç»‘å®š
      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.onclick = () => {
          const format = btn.textContent.trim().toLowerCase();
          window.open(`/download/${format}?temp_dir=${encodeURIComponent(tempDir)}&base_name=${encodeURIComponent(baseName)}`, '_blank');
        };
      });

      // å¤åˆ¶å…¨éƒ¨
      copyAllBtn.onclick = () => {
        const text = segments.map(s => `${s.text}`).join('\n\n');
        navigator.clipboard.writeText(text).then(() => {
          alert('âœ… å­—å¹•å·²å¤åˆ¶ï¼');
        });
      };
    }

    // é˜²æ­¢é»˜è®¤è¡Œä¸º
    window.addEventListener('beforeunload', () => {
      const tempDirs = document.querySelectorAll('[data-temp-dir]');
      tempDirs.forEach(el => {
        const dir = el.dataset.tempDir;
        if (dir && fs.existsSync(dir)) {
          fs.rmSync(dir, { recursive: true });
        }
      });
    });
  </script>
</body>
</html>